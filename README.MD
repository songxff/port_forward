# é€šç”¨ç«¯å£è½¬å‘ç®¡ç†å·¥å…·ä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [å·¥å…·ç®€ä»‹](#å·¥å…·ç®€ä»‹)
- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [å®‰è£…å’Œé…ç½®](#å®‰è£…å’Œé…ç½®)
- [åŸºæœ¬ä½¿ç”¨](#åŸºæœ¬ä½¿ç”¨)
- [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
- [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸš€ å·¥å…·ç®€ä»‹

é€šç”¨ç«¯å£è½¬å‘ç®¡ç†å·¥å…·æ˜¯ä¸€ä¸ªåŸºäºiptablesçš„æ™ºèƒ½ç½‘ç»œä¸­è½¬è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š

- **ä¼˜åŒ–ç½‘ç»œè¿æ¥**ï¼šé€šè¿‡ä¸­è½¬æœåŠ¡å™¨æ”¹å–„ç½‘ç»œå»¶è¿Ÿå’Œç¨³å®šæ€§
- **ç»Ÿä¸€ç®¡ç†ç«¯å£**ï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰ç«¯å£è½¬å‘è§„åˆ™
- **æ™ºèƒ½ç«¯å£åˆ†é…**ï¼šè‡ªåŠ¨æ£€æµ‹ç«¯å£å†²çªå¹¶åˆ†é…å¯ç”¨ç«¯å£
- **ç®€åŒ–é…ç½®**ï¼šæä¾›å‹å¥½çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œiptables

### é€‚ç”¨åœºæ™¯

- ğŸŒ ç½‘ç»œåŠ é€Ÿå’Œä¼˜åŒ–ï¼ˆå¦‚é€šè¿‡é¦™æ¸¯/æ–°åŠ å¡æœåŠ¡å™¨ä¸­è½¬ï¼‰
- ğŸ”’ ç»•è¿‡ç½‘ç»œé™åˆ¶å’Œé˜²ç«å¢™
- ğŸ¢ ä¼ä¸šå†…ç½‘æœåŠ¡å¤–ç½‘è®¿é—®
- ğŸ® æ¸¸æˆæœåŠ¡å™¨åŠ é€Ÿ
- ğŸ“¡ ä»£ç†æœåŠ¡å™¨éƒ¨ç½²

## ğŸ”§ ç³»ç»Ÿè¦æ±‚

### æ”¯æŒçš„æ“ä½œç³»ç»Ÿ

- Ubuntu 18.04+
- Debian 9+
- CentOS 7+
- RHEL 7+
- å…¶ä»–åŸºäºsystemdçš„Linuxå‘è¡Œç‰ˆ

### å¿…éœ€çš„è½¯ä»¶åŒ…

- `iptables`ï¼šé˜²ç«å¢™å’ŒNATåŠŸèƒ½
- `iproute2`ï¼šç½‘ç»œé…ç½®å·¥å…·
- `net-tools`ï¼šç½‘ç»œè¯Šæ–­å·¥å…·

### æƒé™è¦æ±‚

- **Rootæƒé™**ï¼šè„šæœ¬éœ€è¦rootæƒé™æ¥ä¿®æ”¹iptablesè§„åˆ™

## ğŸ“¦ å®‰è£…å’Œé…ç½®

### 1. ä¸‹è½½è„šæœ¬

```bash
# æ–¹æ³•1ï¼šç›´æ¥ä¸‹è½½
wget https://raw.githubusercontent.com/ä½ çš„ä»“åº“/port_forward.sh
chmod +x port_forward.sh

# æ–¹æ³•2ï¼šå¤åˆ¶ç²˜è´´è„šæœ¬å†…å®¹åˆ°æ–‡ä»¶
nano port_forward.sh
chmod +x port_forward.sh
```

### 2. é…ç½®è„šæœ¬å‚æ•°

**é‡è¦ï¼šä½¿ç”¨å‰å¿…é¡»ä¿®æ”¹é…ç½®ï¼**

ç¼–è¾‘è„šæœ¬æ–‡ä»¶ï¼Œæ‰¾åˆ°é…ç½®åŒºåŸŸå¹¶ä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š

```bash
# ç›®æ ‡æœåŠ¡å™¨é…ç½®ï¼ˆéœ€è¦è¢«ä¸­è½¬çš„æœåŠ¡å™¨ï¼‰
TARGET_SERVER_IP="111.xxx.xxx.xxx"          # ä¿®æ”¹ä¸ºä½ çš„ç›®æ ‡æœåŠ¡å™¨IP
TARGET_SERVER_NAME="ç›®æ ‡æœåŠ¡å™¨"            # ä¿®æ”¹ä¸ºä¾¿äºè¯†åˆ«çš„åç§°

# ä¸­è½¬æœåŠ¡å™¨é…ç½®ï¼ˆå½“å‰è¿è¡Œè„šæœ¬çš„æœåŠ¡å™¨ï¼‰
RELAY_SERVER_IP="222.xxx.xxx.xxx"         # ä¿®æ”¹ä¸ºå½“å‰æœåŠ¡å™¨çš„å…¬ç½‘IP
RELAY_SERVER_NAME="ä¸­è½¬æœåŠ¡å™¨"                # ä¿®æ”¹ä¸ºä¾¿äºè¯†åˆ«çš„åç§°

# å¯é€‰é…ç½®
AUTO_PORT_START=40000                     # è‡ªåŠ¨åˆ†é…ç«¯å£çš„èµ·å§‹å€¼
RULES_FILE="/etc/iptables/rules.v4"      # è§„åˆ™ä¿å­˜æ–‡ä»¶è·¯å¾„
```

### 3. éªŒè¯é…ç½®

```bash
# æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®
sudo ./port_forward.sh config

# æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
sudo ./port_forward.sh status
```

### 4. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install iptables iproute2 net-tools iptables-persistent

# CentOS/RHEL
sudo yum install iptables iproute net-tools
# æˆ–è€…ï¼ˆCentOS 8+ï¼‰
sudo dnf install iptables iproute net-tools
```

## ğŸ¯ åŸºæœ¬ä½¿ç”¨

### æ·»åŠ ç«¯å£è½¬å‘

#### 1. ç›¸åŒç«¯å£è½¬å‘

```bash
# è½¬å‘3389ç«¯å£ï¼ˆç›®æ ‡å’Œä¸­è½¬ä½¿ç”¨ç›¸åŒç«¯å£ï¼‰
sudo ./port_forward.sh add 3389

# ç»“æœï¼šè®¿é—® ä¸­è½¬æœåŠ¡å™¨:3389 â†’ ç›®æ ‡æœåŠ¡å™¨:3389
```

#### 2. ä¸åŒç«¯å£æ˜ å°„

```bash
# ç›®æ ‡22ç«¯å£æ˜ å°„åˆ°ä¸­è½¬2222ç«¯å£
sudo ./port_forward.sh add 22 2222

# ç»“æœï¼šè®¿é—® ä¸­è½¬æœåŠ¡å™¨:2222 â†’ ç›®æ ‡æœåŠ¡å™¨:22
```

#### 3. è‡ªåŠ¨ç«¯å£åˆ†é…

```bash
# å¦‚æœ3389ç«¯å£è¢«å ç”¨ï¼Œè‡ªåŠ¨åˆ†é…å…¶ä»–ç«¯å£
sudo ./port_forward.sh auto 3389

# è¾“å‡ºç¤ºä¾‹ï¼š
# [ä¿¡æ¯] è‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨ç«¯å£...
# [æˆåŠŸ] æ‰¾åˆ°å¯ç”¨ç«¯å£: 43389
# [æˆåŠŸ] ç«¯å£è½¬å‘æ·»åŠ æˆåŠŸ!
```

### æŸ¥çœ‹å’Œç®¡ç†

#### æŸ¥çœ‹æ‰€æœ‰è½¬å‘è§„åˆ™

```bash
sudo ./port_forward.sh list
```

#### æŸ¥çœ‹ç‰¹å®šç«¯å£

```bash
sudo ./port_forward.sh list 3389
```

#### æ£€æŸ¥ç«¯å£å ç”¨

```bash
sudo ./port_forward.sh check 8080
```

#### æµ‹è¯•ç«¯å£è½¬å‘

```bash
sudo ./port_forward.sh test 3389
```

### ä¿®æ”¹ç«¯å£è½¬å‘

#### 1. å‘½ä»¤è¡Œä¿®æ”¹ï¼ˆå¿«é€Ÿï¼‰

```bash
# åªä¿®æ”¹ç›®æ ‡ç«¯å£
sudo ./port_forward.sh modify 13389 3390

# åªä¿®æ”¹ä¸­è½¬ç«¯å£
sudo ./port_forward.sh modify 13389 "" 23389

# åŒæ—¶ä¿®æ”¹ç›®æ ‡ç«¯å£å’Œä¸­è½¬ç«¯å£
sudo ./port_forward.sh modify 13389 3390 23389

# å¼ºåˆ¶ä¿®æ”¹ï¼ˆè·³è¿‡ç«¯å£å ç”¨æ£€æŸ¥ï¼‰
sudo ./port_forward.sh modify 13389 3390 23389 --force
```

#### 2. äº¤äº’å¼ä¿®æ”¹ï¼ˆæ¨èï¼‰

```bash
# äº¤äº’å¼ä¿®æ”¹è½¬å‘è§„åˆ™
sudo ./port_forward.sh edit 13389
```

äº¤äº’å¼ä¿®æ”¹ä¼šæä¾›èœå•é€‰æ‹©ï¼š

```
=== ä¿®æ”¹è½¬å‘è§„åˆ™ ===

å½“å‰é…ç½®:
  ä¸­è½¬ç«¯å£: 13389
  ç›®æ ‡ç«¯å£: 3389
  æ˜ å°„å…³ç³»: 111.xxx.xxx.xxx:13389 â†’ 222.xxx.xxx.xxx:3389

ä¿®æ”¹é€‰é¡¹:
  1. åªä¿®æ”¹ç›®æ ‡ç«¯å£
  2. åªä¿®æ”¹ä¸­è½¬ç«¯å£
  3. åŒæ—¶ä¿®æ”¹ç›®æ ‡ç«¯å£å’Œä¸­è½¬ç«¯å£
  4. å–æ¶ˆä¿®æ”¹

è¯·é€‰æ‹©ä¿®æ”¹é€‰é¡¹ (1-4): 
```

### åˆ é™¤ç«¯å£è½¬å‘

```bash
# åˆ é™¤è½¬å‘è§„åˆ™ï¼ˆä¼šæœ‰ç¡®è®¤æç¤ºï¼‰
sudo ./port_forward.sh remove 3389

# å¼ºåˆ¶åˆ é™¤ï¼ˆè·³è¿‡ç¡®è®¤ï¼‰
sudo ./port_forward.sh remove 3389 --force
```

### ä¿å­˜é…ç½®

```bash
# ä¿å­˜å½“å‰è§„åˆ™ï¼ˆé‡å¯åè‡ªåŠ¨ç”Ÿæ•ˆï¼‰
sudo ./port_forward.sh save
```

## ğŸ”¬ é«˜çº§åŠŸèƒ½

### æ‰¹é‡ç«¯å£ç®¡ç†

#### æ‰¹é‡æ·»åŠ ç«¯å£èŒƒå›´

```bash
# æ·»åŠ 30000-30100ç«¯å£èŒƒå›´
sudo ./port_forward.sh range 30000 30100
```

#### æŸ¥æ‰¾å¯ç”¨ç«¯å£

```bash
# ä»40000å¼€å§‹æŸ¥æ‰¾å¯ç”¨ç«¯å£
sudo ./port_forward.sh find-free 40000
```

### è§„åˆ™å¤‡ä»½å’Œæ¢å¤

#### å¤‡ä»½å½“å‰è§„åˆ™

```bash
sudo ./port_forward.sh backup
# è¾“å‡ºï¼šè§„åˆ™å·²å¤‡ä»½åˆ° /root/iptables_backup_20231201_143022.txt
```

#### æ¢å¤ä¿å­˜çš„è§„åˆ™

```bash
sudo ./port_forward.sh restore
```

### ç³»ç»Ÿç»´æŠ¤

#### æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€

```bash
sudo ./port_forward.sh status
```

#### æ¸…ç†è§„åˆ™

```bash
sudo ./port_forward.sh cleanup
```

#### æŸ¥çœ‹è¿æ¥ä¿¡æ¯

```bash
sudo ./port_forward.sh info
```

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šä»£ç†æœåŠ¡å™¨ä¸­è½¬

**éœ€æ±‚**ï¼šæœ‰ä¸€å°å¾·å›½VPSè¿è¡Œä»£ç†æœåŠ¡ï¼Œä½†å›½å†…è®¿é—®é€Ÿåº¦æ…¢ï¼Œå¸Œæœ›é€šè¿‡è…¾è®¯äº‘ä¸­è½¬åŠ é€Ÿã€‚

**é…ç½®**ï¼š

```bash
# 1. åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šé…ç½®è„šæœ¬
TARGET_SERVER_IP="111.xxx.xxx.xxx"    # å¾·å›½VPS IP
RELAY_SERVER_IP="222.xxx.xxx.xxx"   # è…¾è®¯äº‘IP

# 2. æ·»åŠ ä»£ç†ç«¯å£è½¬å‘
sudo ./port_forward.sh add 31212   # Realityåè®®
sudo ./port_forward.sh add 6666    # SOCKSä»£ç†
sudo ./port_forward.sh add 443     # HTTPSä»£ç†

# 3. ä¿®æ”¹å®¢æˆ·ç«¯é…ç½®
# åŸæ¥ï¼š@111.xxx.xxx.xxx:31212
# ä¿®æ”¹ä¸ºï¼š@222.xxx.xxx.xxx:31212
```

### åœºæ™¯2ï¼šæ¸¸æˆæœåŠ¡å™¨åŠ é€Ÿ

**éœ€æ±‚**ï¼šæ¸¸æˆæœåŠ¡å™¨åœ¨æµ·å¤–ï¼Œå»¶è¿Ÿé«˜ï¼Œé€šè¿‡é¦™æ¸¯æœåŠ¡å™¨ä¸­è½¬ã€‚

**é…ç½®**ï¼š

```bash
# æ·»åŠ æ¸¸æˆç«¯å£
sudo ./port_forward.sh add 25565   # Minecraft
sudo ./port_forward.sh add 7777    # å…¶ä»–æ¸¸æˆ

# ç©å®¶è¿æ¥é¦™æ¸¯æœåŠ¡å™¨IPå’Œç«¯å£å³å¯
```

### åœºæ™¯3ï¼šä¼ä¸šå†…ç½‘æœåŠ¡

**éœ€æ±‚**ï¼šä¼ä¸šå†…ç½‘çš„RDP/SSHæœåŠ¡éœ€è¦å¤–ç½‘è®¿é—®ï¼Œä½†ä¸æƒ³ç›´æ¥æš´éœ²ã€‚

**é…ç½®**ï¼š

```bash
# SSHç«¯å£æ˜ å°„ï¼ˆé¿å…22ç«¯å£å†²çªï¼‰
sudo ./port_forward.sh map 22 2222

# RDPç«¯å£è½¬å‘
sudo ./port_forward.sh add 3389

# æ•°æ®åº“ç«¯å£è½¬å‘
sudo ./port_forward.sh add 3306 13306
```

### åœºæ™¯5ï¼šç«¯å£è§„åˆ™è°ƒæ•´

**éœ€æ±‚**ï¼šå·²æœ‰çš„è½¬å‘è§„åˆ™éœ€è¦è°ƒæ•´ç«¯å£å·ï¼Œé¿å…é‡æ–°é…ç½®ã€‚

**é…ç½®**ï¼š

```bash
# æŸ¥çœ‹ç°æœ‰è§„åˆ™
sudo ./port_forward.sh list

# ä¿®æ”¹è§„åˆ™ï¼šå°†3389ç«¯å£æ”¹ä¸º3390ç«¯å£
sudo ./port_forward.sh modify 13389 3390

# äº¤äº’å¼ä¿®æ”¹ï¼ˆæ¨èï¼‰
sudo ./port_forward.sh edit 13389

# æ‰¹é‡è°ƒæ•´ï¼šå¦‚æœéœ€è¦ä¿®æ”¹å¤šä¸ªç«¯å£
for port in 13389 13390 13391; do
    sudo ./port_forward.sh modify $port $((port + 1000))
done
```

### åœºæ™¯6ï¼šç´§æ€¥ç«¯å£æ›´æ¢

**éœ€æ±‚**ï¼šä¸­è½¬æœåŠ¡å™¨çš„æŸä¸ªç«¯å£è¢«å…¶ä»–æœåŠ¡å ç”¨ï¼Œéœ€è¦ç´§æ€¥æ›´æ¢ã€‚

**é…ç½®**ï¼š

```bash
# æ£€æŸ¥ç«¯å£å†²çª
sudo ./port_forward.sh check 8080

# å¦‚æœ8080è¢«å ç”¨ï¼Œä¿®æ”¹åˆ°å…¶ä»–ç«¯å£
sudo ./port_forward.sh modify 8080 "" 18080

# æˆ–è€…ä½¿ç”¨è‡ªåŠ¨åˆ†é…åŠŸèƒ½
sudo ./port_forward.sh auto 8080  # é‡æ–°æ·»åŠ åˆ°æ–°ç«¯å£
sudo ./port_forward.sh remove 8080 --force  # åˆ é™¤æ—§è§„åˆ™
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### 1. æƒé™é”™è¯¯

```
é”™è¯¯: æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
sudo ./port_forward.sh [å‘½ä»¤]
```

#### 2. é…ç½®æœªè®¾ç½®

```
é”™è¯¯: è¯·å…ˆé…ç½®ç›®æ ‡æœåŠ¡å™¨IP
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹`TARGET_SERVER_IP`å’Œ`RELAY_SERVER_IP`å˜é‡ã€‚

#### 3. ç«¯å£è¢«å ç”¨

```
è­¦å‘Š: ä¸­è½¬ç«¯å£ 3389 ä¸å¯ç”¨: ç³»ç»Ÿå ç”¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨è¯¦æƒ…
sudo ./port_forward.sh check 3389

# ä½¿ç”¨è‡ªåŠ¨åˆ†é…
sudo ./port_forward.sh auto 3389

# æˆ–æ‰‹åŠ¨æŒ‡å®šå…¶ä»–ç«¯å£
sudo ./port_forward.sh add 3389 13389
```

#### 4. è¿æ¥æµ‹è¯•å¤±è´¥

```
è­¦å‘Š: ä¸­è½¬ç«¯å£ 3389 è¿æ¥å¤±è´¥ï¼ˆç›®æ ‡æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨æ˜¯å¦å¯è¾¾ï¼š`ping ç›®æ ‡IP`
2. æ£€æŸ¥ç›®æ ‡ç«¯å£æ˜¯å¦æœ‰æœåŠ¡ï¼š`telnet ç›®æ ‡IP ç«¯å£`
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨çš„é˜²ç«å¢™é…ç½®

#### 5. è§„åˆ™ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. ç¡®è®¤IPè½¬å‘å·²å¯ç”¨
cat /proc/sys/net/ipv4/ip_forward

# 2. æŸ¥çœ‹iptablesè§„åˆ™
sudo iptables -t nat -L PREROUTING -n

# 3. é‡æ–°å¯ç”¨IPè½¬å‘
echo 1 > /proc/sys/net/ipv4/ip_forward

# 4. é‡æ–°åŠ è½½è§„åˆ™
sudo ./port_forward.sh restore
```

### ç½‘ç»œè¯Šæ–­å‘½ä»¤

```bash
# æ£€æŸ¥åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿é€šæ€§
ping -c 4 ç›®æ ‡æœåŠ¡å™¨IP

# æ£€æŸ¥ç›®æ ‡ç«¯å£æ˜¯å¦å¼€æ”¾
telnet ç›®æ ‡æœåŠ¡å™¨IP ç«¯å£

# æŸ¥çœ‹æœ¬åœ°ç«¯å£ç›‘å¬
ss -tulpn | grep ç«¯å£å·

# æŸ¥çœ‹iptablesè§„åˆ™
sudo iptables -t nat -L -n --line-numbers

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
sudo netstat -tulpn
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨æ³¨æ„äº‹é¡¹

1. **é˜²ç«å¢™é…ç½®**
   - ç¡®ä¿ä¸­è½¬æœåŠ¡å™¨çš„å®‰å…¨ç»„/é˜²ç«å¢™å¼€æ”¾ç›¸åº”ç«¯å£
   - ä¸è¦å¼€æ”¾ä¸å¿…è¦çš„ç«¯å£èŒƒå›´
   - å®šæœŸå®¡æŸ¥è½¬å‘è§„åˆ™
2. **è®¿é—®æ§åˆ¶**
   - è€ƒè™‘æ·»åŠ æºIPé™åˆ¶
   - ä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥è®¤è¯
   - å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶
3. **ç›‘æ§å’Œæ—¥å¿—**
   - ç›‘æ§å¼‚å¸¸æµé‡
   - è®¾ç½®æ—¥å¿—è®°å½•
   - å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€

### æ€§èƒ½æ³¨æ„äº‹é¡¹

1. **å¸¦å®½é™åˆ¶**
   - ä¸­è½¬ä¼šå¢åŠ å¸¦å®½æ¶ˆè€—
   - æ³¨æ„æœåŠ¡å™¨å¸¦å®½é™åˆ¶
   - è€ƒè™‘ä½¿ç”¨CDNæˆ–å¤šèŠ‚ç‚¹åˆ†æµ
2. **å»¶è¿Ÿå½±å“**
   - ä¸­è½¬ä¼šå¢åŠ ä¸€å®šå»¶è¿Ÿ
   - é€‰æ‹©åœ°ç†ä½ç½®è¾ƒè¿‘çš„ä¸­è½¬æœåŠ¡å™¨
   - ä¼˜åŒ–ç½‘ç»œè·¯ç”±
3. **èµ„æºä½¿ç”¨**
   - å¤§é‡è½¬å‘è§„åˆ™å¯èƒ½å½±å“æ€§èƒ½
   - å®šæœŸæ¸…ç†ä¸ç”¨çš„è§„åˆ™
   - ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨

### ç»´æŠ¤å»ºè®®

1. **å®šæœŸå¤‡ä»½**

   ```bash
   # æ¯å‘¨å¤‡ä»½è§„åˆ™
   sudo ./port_forward.sh backup
   ```

2. **è§„åˆ™æ¸…ç†**

   ```bash
   # å®šæœŸæ£€æŸ¥å’Œæ¸…ç†è§„åˆ™
   sudo ./port_forward.sh cleanup
   sudo ./port_forward.sh list
   ```

3. **æ›´æ–°æ£€æŸ¥**

   - å®šæœŸæ£€æŸ¥è„šæœ¬æ›´æ–°
   - å…³æ³¨å®‰å…¨è¡¥ä¸
   - æµ‹è¯•æ–°åŠŸèƒ½

## â“ å¸¸è§é—®é¢˜

### Q: è„šæœ¬æ”¯æŒIPv6å—ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬ä¸»è¦æ”¯æŒIPv4ï¼ŒIPv6æ”¯æŒåœ¨è®¡åˆ’ä¸­ã€‚å¦‚éœ€IPv6æ”¯æŒï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ ç›¸åº”çš„ip6tablesè§„åˆ™ã€‚

### Q: å¯ä»¥åŒæ—¶è½¬å‘UDPå’ŒTCPå—ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬ä¸»è¦é’ˆå¯¹TCPåè®®ã€‚å¦‚éœ€UDPè½¬å‘ï¼Œå¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„åè®®å‚æ•°ï¼š

```bash
iptables -t nat -A PREROUTING -p udp --dport ç«¯å£ -j DNAT --to-destination ç›®æ ‡IP:ç«¯å£
```

### Q: å¦‚ä½•é™åˆ¶æºIPè®¿é—®ï¼Ÿ

A: å¯ä»¥åœ¨æ·»åŠ è§„åˆ™æ—¶æŒ‡å®šæºIPï¼š

```bash
iptables -t nat -A PREROUTING -s æºIP -p tcp --dport ç«¯å£ -j DNAT --to-destination ç›®æ ‡IP:ç«¯å£
```

### Q: è½¬å‘è§„åˆ™é‡å¯åä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

A: ä½¿ç”¨ä¿å­˜å‘½ä»¤å¹¶å®‰è£…iptables-persistentï¼š

```bash
sudo ./port_forward.sh save
sudo apt install iptables-persistent  # Ubuntu/Debian
```

### Q: å¦‚ä½•ç›‘æ§è½¬å‘æµé‡ï¼Ÿ

A: å¯ä»¥ä½¿ç”¨iptablesçš„è®¡æ•°åŠŸèƒ½ï¼š

```bash
# æŸ¥çœ‹è§„åˆ™ç»Ÿè®¡
sudo iptables -t nat -L PREROUTING -n -v
```

### Q: å¦‚ä½•ä¿®æ”¹å·²æœ‰çš„è½¬å‘è§„åˆ™ï¼Ÿ

A: æœ‰ä¸¤ç§æ–¹å¼ï¼š

```bash
# å‘½ä»¤è¡Œä¿®æ”¹ï¼ˆé€‚åˆè„šæœ¬åŒ–ï¼‰
sudo ./port_forward.sh modify <ä¸­è½¬ç«¯å£> [æ–°ç›®æ ‡ç«¯å£] [æ–°ä¸­è½¬ç«¯å£]

# äº¤äº’å¼ä¿®æ”¹ï¼ˆç”¨æˆ·å‹å¥½ï¼‰
sudo ./port_forward.sh edit <ä¸­è½¬ç«¯å£>
```

### Q: ä¿®æ”¹è§„åˆ™æ—¶ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

A: å¯ä»¥ä½¿ç”¨`--force`å‚æ•°å¼ºåˆ¶ä¿®æ”¹ï¼Œæˆ–é€‰æ‹©å…¶ä»–ç«¯å£ï¼š

```bash
sudo ./port_forward.sh modify 8080 "" 18080 --force
```

### Q: å¦‚ä½•æ‰¹é‡ä¿®æ”¹ç«¯å£ï¼Ÿ

A: å¯ä»¥ä½¿ç”¨å¾ªç¯è„šæœ¬ï¼š

```bash
# å°†30000-30010ç«¯å£çš„ç›®æ ‡éƒ½æ”¹ä¸º40000-40010
for i in {0..10}; do
    sudo ./port_forward.sh modify $((30000+i)) $((40000+i))
done
```

### Q: å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ï¼Ÿ

A: å¯ä»¥ä½¿ç”¨iptablesçš„randomæ¨¡å—æˆ–é…åˆå…¶ä»–è´Ÿè½½å‡è¡¡å·¥å…·ï¼š

```bash
iptables -t nat -A PREROUTING -p tcp --dport 80 -m statistic --mode random --probability 0.5 -j DNAT --to-destination æœåŠ¡å™¨1:80
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination æœåŠ¡å™¨2:80
```

### Q: æ”¯æŒç«¯å£èŒƒå›´è½¬å‘å—ï¼Ÿ

A: æ”¯æŒï¼Œä½¿ç”¨rangeå‘½ä»¤ï¼š

```bash
sudo ./port_forward.sh range 30000 30100
```

## ğŸ“š æ›´å¤šèµ„æº

- [iptableså®˜æ–¹æ–‡æ¡£](https://netfilter.org/documentation/)
- [Linuxç½‘ç»œé…ç½®æŒ‡å—](https://www.kernel.org/doc/Documentation/networking/)
- [ç½‘ç»œæ•…éšœæ’é™¤æŒ‡å—](https://www.tldp.org/LDP/nag2/index.html)

## ä»£ç :

```
#!/bin/bash

#================================================================
# é€šç”¨ç«¯å£è½¬å‘ç®¡ç†è„šæœ¬ (Universal Port Forwarding Manager)
# ç‰ˆæœ¬: 2.0
# ä½œè€…: Assistant
# æè¿°: åŸºäºiptablesçš„æ™ºèƒ½ç«¯å£è½¬å‘ç®¡ç†å·¥å…·
# æ”¯æŒ: Ubuntu/Debian/CentOS/RHELç­‰Linuxå‘è¡Œç‰ˆ
#================================================================

#================================================================
# é…ç½®åŒºåŸŸ - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
#================================================================

# ç›®æ ‡æœåŠ¡å™¨é…ç½®ï¼ˆéœ€è¦è¢«ä¸­è½¬çš„æœåŠ¡å™¨ï¼‰
TARGET_SERVER_IP="ç›®æ ‡æœåŠ¡å™¨IP"          # ä¾‹å¦‚: "111.xxx.xxx.xxx"
TARGET_SERVER_NAME="ç›®æ ‡æœåŠ¡å™¨"           # ä¾‹å¦‚: "å¾·å›½æœåŠ¡å™¨"

# ä¸­è½¬æœåŠ¡å™¨é…ç½®ï¼ˆå½“å‰è¿è¡Œè„šæœ¬çš„æœåŠ¡å™¨ï¼‰
RELAY_SERVER_IP="ä¸­è½¬æœåŠ¡å™¨IP"           # ä¾‹å¦‚: "222.xxx.xxx.xxx" 
RELAY_SERVER_NAME="ä¸­è½¬æœåŠ¡å™¨"           # ä¾‹å¦‚: "è…¾è®¯äº‘"

# è§„åˆ™ä¿å­˜æ–‡ä»¶è·¯å¾„
RULES_FILE="/etc/iptables/rules.v4"

# è‡ªåŠ¨åˆ†é…ç«¯å£çš„èµ·å§‹èŒƒå›´ï¼ˆé¿å…ä¸å¸¸ç”¨ç«¯å£å†²çªï¼‰
AUTO_PORT_START=40000

#================================================================
# é¢œè‰²å®šä¹‰
#================================================================
RED='\033[0;31m'        # é”™è¯¯ä¿¡æ¯
GREEN='\033[0;32m'      # æˆåŠŸä¿¡æ¯
YELLOW='\033[1;33m'     # è­¦å‘Šä¿¡æ¯
BLUE='\033[0;34m'       # ä¿¡æ¯æ ‡é¢˜
CYAN='\033[0;36m'       # è¾…åŠ©ä¿¡æ¯
PURPLE='\033[0;35m'     # å¼ºè°ƒä¿¡æ¯
NC='\033[0m'            # æ— é¢œè‰²

#================================================================
# å·¥å…·å‡½æ•°
#================================================================

# æ˜¾ç¤ºå¸¦é¢œè‰²çš„æ¶ˆæ¯
log_info() { echo -e "${BLUE}[ä¿¡æ¯]${NC} $1"; }
log_success() { echo -e "${GREEN}[æˆåŠŸ]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[è­¦å‘Š]${NC} $1"; }
log_error() { echo -e "${RED}[é”™è¯¯]${NC} $1"; }
log_debug() { echo -e "${CYAN}[è°ƒè¯•]${NC} $1"; }

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
check_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ"
        log_info "è¯·ä½¿ç”¨: sudo $0 æˆ–åˆ‡æ¢åˆ°rootç”¨æˆ·"
        exit 1
    fi
}

# æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
check_config() {
    if [ "$TARGET_SERVER_IP" = "ç›®æ ‡æœåŠ¡å™¨IP" ] || [ -z "$TARGET_SERVER_IP" ]; then
        log_error "è¯·å…ˆé…ç½®ç›®æ ‡æœåŠ¡å™¨IP"
        log_info "ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ TARGET_SERVER_IP å˜é‡"
        exit 1
    fi
    
    if [ "$RELAY_SERVER_IP" = "ä¸­è½¬æœåŠ¡å™¨IP" ] || [ -z "$RELAY_SERVER_IP" ]; then
        log_error "è¯·å…ˆé…ç½®ä¸­è½¬æœåŠ¡å™¨IP"
        log_info "ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ RELAY_SERVER_IP å˜é‡"
        exit 1
    fi
}

# éªŒè¯IPåœ°å€æ ¼å¼
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    else
        return 1
    fi
}

# éªŒè¯ç«¯å£å·
validate_port() {
    local port=$1
    if [[ "$port" =~ ^[0-9]+$ ]] && [ "$port" -ge 1 ] && [ "$port" -le 65535 ]; then
        return 0
    else
        return 1
    fi
}

# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
check_dependencies() {
    local missing_deps=()
    
    # æ£€æŸ¥å¿…éœ€çš„å‘½ä»¤
    local required_commands=("iptables" "ss" "netstat")
    
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_deps+=("$cmd")
        fi
    done
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        log_error "ç¼ºå°‘å¿…éœ€çš„å‘½ä»¤: ${missing_deps[*]}"
        log_info "è¯·å®‰è£…ç›¸åº”çš„è½¯ä»¶åŒ…"
        log_info "Ubuntu/Debian: apt install iptables iproute2 net-tools"
        log_info "CentOS/RHEL: yum install iptables iproute net-tools"
        exit 1
    fi
}

# å¯ç”¨IPè½¬å‘
enable_ip_forward() {
    # æ£€æŸ¥IPè½¬å‘æ˜¯å¦å·²å¯ç”¨
    if [ "$(cat /proc/sys/net/ipv4/ip_forward)" = "1" ]; then
        log_debug "IPè½¬å‘å·²å¯ç”¨"
        return 0
    fi
    
    log_info "å¯ç”¨IPè½¬å‘..."
    
    # ä¸´æ—¶å¯ç”¨
    echo 1 > /proc/sys/net/ipv4/ip_forward
    
    # æ°¸ä¹…å¯ç”¨
    if ! grep -q "net.ipv4.ip_forward=1" /etc/sysctl.conf; then
        echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
        log_success "IPè½¬å‘å·²æ°¸ä¹…å¯ç”¨"
    fi
    
    # ä½¿é…ç½®ç”Ÿæ•ˆ
    sysctl -p >/dev/null 2>&1
}

#================================================================
# ç«¯å£æ£€æµ‹å‡½æ•°
#================================================================

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«ç³»ç»Ÿè¿›ç¨‹å ç”¨
check_port_in_use() {
    local port=$1
    
    # ä½¿ç”¨sså‘½ä»¤æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
    if ss -tulpn 2>/dev/null | grep -q ":$port "; then
        return 0  # ç«¯å£è¢«å ç”¨
    fi
    
    # å¤‡ç”¨æ£€æŸ¥æ–¹æ³•ï¼ˆä½¿ç”¨netstatï¼‰
    if netstat -tulpn 2>/dev/null | grep -q ":$port "; then
        return 0  # ç«¯å£è¢«å ç”¨
    fi
    
    return 1  # ç«¯å£å¯ç”¨
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦å·²æœ‰è½¬å‘è§„åˆ™
check_forward_exists() {
    local relay_port=$1
    iptables -t nat -L PREROUTING -n 2>/dev/null | grep -q "dpt:$relay_port.*to:$TARGET_SERVER_IP"
}

# è·å–ç«¯å£å ç”¨çš„è¯¦ç»†ä¿¡æ¯
get_port_usage_detail() {
    local port=$1
    local details=()
    
    # æ£€æŸ¥ç³»ç»Ÿè¿›ç¨‹å ç”¨
    local process_info=$(ss -tulpn 2>/dev/null | grep ":$port " | head -5)
    if [ -n "$process_info" ]; then
        details+=("ç³»ç»Ÿå ç”¨")
        while IFS= read -r line; do
            details+=("  $line")
        done <<< "$process_info"
    fi
    
    # æ£€æŸ¥è½¬å‘è§„åˆ™å ç”¨
    local forward_info=$(iptables -t nat -L PREROUTING -n --line-numbers 2>/dev/null | grep "dpt:$port")
    if [ -n "$forward_info" ]; then
        details+=("è½¬å‘å ç”¨")
        while IFS= read -r line; do
            details+=("  $line")
        done <<< "$forward_info"
    fi
    
    # è¾“å‡ºè¯¦æƒ…
    if [ ${#details[@]} -gt 0 ]; then
        printf '%s\n' "${details[@]}"
        return 1  # ç«¯å£è¢«å ç”¨
    else
        echo "ç«¯å£å¯ç”¨"
        return 0  # ç«¯å£å¯ç”¨
    fi
}

# ç»¼åˆæ£€æŸ¥ç«¯å£å¯ç”¨æ€§
check_port_available() {
    local port=$1
    local issues=()
    
    # æ£€æŸ¥ç³»ç»Ÿå ç”¨
    if check_port_in_use "$port"; then
        issues+=("system")
    fi
    
    # æ£€æŸ¥è½¬å‘è§„åˆ™
    if check_forward_exists "$port"; then
        issues+=("forward")
    fi
    
    if [ ${#issues[@]} -eq 0 ]; then
        echo "available"
        return 0
    else
        echo "${issues[*]}"
        return 1
    fi
}

# æŸ¥æ‰¾å¯ç”¨ç«¯å£
find_available_port() {
    local start_port=${1:-$AUTO_PORT_START}
    local max_attempts=${2:-1000}
    local attempt=0
    
    log_info "ä»ç«¯å£ $start_port å¼€å§‹æŸ¥æ‰¾å¯ç”¨ç«¯å£..."
    
    for ((port=$start_port; port<=65535 && attempt<$max_attempts; port++)); do
        ((attempt++))
        
        # æ£€æŸ¥ç«¯å£å¯ç”¨æ€§
        local status=$(check_port_available "$port")
        
        if [ "$status" = "available" ]; then
            echo "$port"
            return 0
        fi
        
        # æ˜¾ç¤ºæœç´¢è¿›åº¦
        if [ $((attempt % 100)) -eq 0 ]; then
            log_debug "å·²æ£€æŸ¥ $attempt ä¸ªç«¯å£ï¼Œå½“å‰æ£€æŸ¥: $port"
        fi
    done
    
    log_error "åœ¨ $max_attempts æ¬¡å°è¯•å†…æœªæ‰¾åˆ°å¯ç”¨ç«¯å£"
    return 1
}

#================================================================
# è½¬å‘è§„åˆ™ç®¡ç†å‡½æ•°
#================================================================

# æ·»åŠ ç«¯å£è½¬å‘è§„åˆ™
add_port_forward() {
    local target_port=$1      # ç›®æ ‡æœåŠ¡å™¨ç«¯å£
    local relay_port=$2       # ä¸­è½¬æœåŠ¡å™¨ç«¯å£
    local auto_assign=${3:-false}  # æ˜¯å¦è‡ªåŠ¨åˆ†é…ç«¯å£
    
    # å‚æ•°éªŒè¯
    if ! validate_port "$target_port"; then
        log_error "æ— æ•ˆçš„ç›®æ ‡ç«¯å£: $target_port"
        return 1
    fi
    
    # å¦‚æœæœªæŒ‡å®šä¸­è½¬ç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨ç›¸åŒç«¯å£
    if [ -z "$relay_port" ]; then
        relay_port=$target_port
    elif ! validate_port "$relay_port"; then
        log_error "æ— æ•ˆçš„ä¸­è½¬ç«¯å£: $relay_port"
        return 1
    fi
    
    # æ£€æŸ¥ä¸­è½¬ç«¯å£å¯ç”¨æ€§
    local port_status=$(check_port_available "$relay_port")
    
    if [ "$port_status" != "available" ]; then
        log_warning "ä¸­è½¬ç«¯å£ $relay_port ä¸å¯ç”¨:"
        get_port_usage_detail "$relay_port" | while IFS= read -r line; do
            echo "  $line"
        done
        
        # å¦‚æœå¯ç”¨è‡ªåŠ¨åˆ†é…ï¼ŒæŸ¥æ‰¾å¯ç”¨ç«¯å£
        if [ "$auto_assign" = "true" ]; then
            log_info "è‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨ç«¯å£..."
            local new_port=$(find_available_port "$relay_port")
            if [ $? -eq 0 ] && [ -n "$new_port" ]; then
                relay_port=$new_port
                log_success "è‡ªåŠ¨åˆ†é…ç«¯å£: $relay_port"
            else
                log_error "æ— æ³•æ‰¾åˆ°å¯ç”¨ç«¯å£"
                return 1
            fi
        else
            log_info "å»ºè®®è§£å†³æ–¹æ¡ˆ:"
            log_info "  1. ä½¿ç”¨è‡ªåŠ¨åˆ†é…: $0 auto $target_port"
            log_info "  2. æŸ¥æ‰¾å¯ç”¨ç«¯å£: $0 find-free $relay_port"
            log_info "  3. æŒ‡å®šå…¶ä»–ç«¯å£: $0 add $target_port <å…¶ä»–ç«¯å£>"
            return 1
        fi
    fi
    
    # ç¡®ä¿IPè½¬å‘å·²å¯ç”¨
    enable_ip_forward
    
    # æ·»åŠ iptablesè§„åˆ™
    log_info "æ·»åŠ è½¬å‘è§„åˆ™: $RELAY_SERVER_IP:$relay_port â†’ $TARGET_SERVER_IP:$target_port"
    
    # PREROUTINGè§„åˆ™ï¼šå°†è¿›å…¥ä¸­è½¬æœåŠ¡å™¨çš„æµé‡è½¬å‘åˆ°ç›®æ ‡æœåŠ¡å™¨
    if ! iptables -t nat -A PREROUTING -p tcp --dport "$relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$target_port"; then
        log_error "æ·»åŠ PREROUTINGè§„åˆ™å¤±è´¥"
        return 1
    fi
    
    # FORWARDè§„åˆ™ï¼šå…è®¸è½¬å‘çš„æµé‡é€šè¿‡
    if ! iptables -A FORWARD -p tcp --dport "$target_port" -j ACCEPT; then
        log_error "æ·»åŠ FORWARDè§„åˆ™å¤±è´¥"
        # æ¸…ç†å·²æ·»åŠ çš„PREROUTINGè§„åˆ™
        iptables -t nat -D PREROUTING -p tcp --dport "$relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$target_port" 2>/dev/null
        return 1
    fi
    
    # POSTROUTINGè§„åˆ™ï¼šç¡®ä¿å›ç¨‹æµé‡æ­£ç¡®è·¯ç”±
    if ! iptables -t nat -C POSTROUTING -j MASQUERADE 2>/dev/null; then
        iptables -t nat -A POSTROUTING -j MASQUERADE
    fi
    
    # éªŒè¯è§„åˆ™æ˜¯å¦æ·»åŠ æˆåŠŸ
    if check_forward_exists "$relay_port"; then
        log_success "ç«¯å£è½¬å‘æ·»åŠ æˆåŠŸ!"
        echo ""
        log_info "è½¬å‘é…ç½®:"
        echo "  ${TARGET_SERVER_NAME}: $TARGET_SERVER_IP:$target_port"
        echo "  ${RELAY_SERVER_NAME}è®¿é—®: $RELAY_SERVER_IP:$relay_port"
        echo ""
        
        # å¦‚æœç«¯å£ä¸åŒï¼Œæä¾›é…ç½®ä¿®æ”¹å»ºè®®
        if [ "$target_port" != "$relay_port" ]; then
            log_info "é…ç½®ä¿®æ”¹å»ºè®®:"
            echo "  åŸé…ç½®: @$TARGET_SERVER_IP:$target_port"
            echo "  æ–°é…ç½®: @$RELAY_SERVER_IP:$relay_port"
        fi
        
        return 0
    else
        log_error "è½¬å‘è§„åˆ™éªŒè¯å¤±è´¥"
        return 1
    fi
}

# ä¿®æ”¹ç«¯å£è½¬å‘è§„åˆ™
modify_port_forward() {
    local old_relay_port=$1
    local new_target_port=$2
    local new_relay_port=$3
    local force=${4:-false}
    
    # å‚æ•°éªŒè¯
    if ! validate_port "$old_relay_port"; then
        log_error "æ— æ•ˆçš„åŸä¸­è½¬ç«¯å£: $old_relay_port"
        return 1
    fi
    
    # æ£€æŸ¥åŸè§„åˆ™æ˜¯å¦å­˜åœ¨
    if ! check_forward_exists "$old_relay_port"; then
        log_error "ä¸­è½¬ç«¯å£ $old_relay_port æ²¡æœ‰è½¬å‘è§„åˆ™"
        log_info "ä½¿ç”¨ '$0 list' æŸ¥çœ‹ç°æœ‰è§„åˆ™"
        return 1
    fi
    
    # è·å–åŸè§„åˆ™ä¿¡æ¯
    local rule_info=$(iptables -t nat -L PREROUTING -n --line-numbers 2>/dev/null | grep "dpt:$old_relay_port.*to:$TARGET_SERVER_IP")
    local old_target_port=$(echo "$rule_info" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
    
    log_info "å½“å‰è§„åˆ™: $RELAY_SERVER_IP:$old_relay_port â†’ $TARGET_SERVER_IP:$old_target_port"
    
    # éªŒè¯æ–°å‚æ•°
    if [ -n "$new_target_port" ] && ! validate_port "$new_target_port"; then
        log_error "æ— æ•ˆçš„æ–°ç›®æ ‡ç«¯å£: $new_target_port"
        return 1
    fi
    
    if [ -n "$new_relay_port" ] && ! validate_port "$new_relay_port"; then
        log_error "æ— æ•ˆçš„æ–°ä¸­è½¬ç«¯å£: $new_relay_port"
        return 1
    fi
    
    # è®¾ç½®é»˜è®¤å€¼
    local final_target_port=${new_target_port:-$old_target_port}
    local final_relay_port=${new_relay_port:-$old_relay_port}
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜åŒ–
    if [ "$final_target_port" = "$old_target_port" ] && [ "$final_relay_port" = "$old_relay_port" ]; then
        log_warning "æ–°é…ç½®ä¸åŸé…ç½®ç›¸åŒï¼Œæ— éœ€ä¿®æ”¹"
        return 0
    fi
    
    # å¦‚æœä¸­è½¬ç«¯å£æœ‰å˜åŒ–ï¼Œæ£€æŸ¥æ–°ç«¯å£å¯ç”¨æ€§
    if [ "$final_relay_port" != "$old_relay_port" ]; then
        local port_status=$(check_port_available "$final_relay_port")
        
        if [ "$port_status" != "available" ] && [ "$force" != "true" ]; then
            log_error "æ–°ä¸­è½¬ç«¯å£ $final_relay_port ä¸å¯ç”¨:"
            get_port_usage_detail "$final_relay_port" | while IFS= read -r line; do
                echo "  $line"
            done
            log_info "ä½¿ç”¨ --force å‚æ•°å¼ºåˆ¶ä¿®æ”¹ï¼Œæˆ–é€‰æ‹©å…¶ä»–ç«¯å£"
            return 1
        fi
    fi
    
    log_info "ä¿®æ”¹è½¬å‘è§„åˆ™:"
    echo "  åŸé…ç½®: $RELAY_SERVER_IP:$old_relay_port â†’ $TARGET_SERVER_IP:$old_target_port"
    echo "  æ–°é…ç½®: $RELAY_SERVER_IP:$final_relay_port â†’ $TARGET_SERVER_IP:$final_target_port"
    
    # åˆ é™¤åŸè§„åˆ™
    log_debug "åˆ é™¤åŸè½¬å‘è§„åˆ™..."
    if ! iptables -t nat -D PREROUTING -p tcp --dport "$old_relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$old_target_port" 2>/dev/null; then
        log_error "åˆ é™¤åŸPREROUTINGè§„åˆ™å¤±è´¥"
        return 1
    fi
    
    if ! iptables -D FORWARD -p tcp --dport "$old_target_port" -j ACCEPT 2>/dev/null; then
        log_warning "åˆ é™¤åŸFORWARDè§„åˆ™å¤±è´¥ï¼ˆå¯èƒ½ä¸å…¶ä»–è§„åˆ™å…±äº«ï¼‰"
    fi
    
    # æ·»åŠ æ–°è§„åˆ™
    log_debug "æ·»åŠ æ–°è½¬å‘è§„åˆ™..."
    if ! iptables -t nat -A PREROUTING -p tcp --dport "$final_relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$final_target_port"; then
        log_error "æ·»åŠ æ–°PREROUTINGè§„åˆ™å¤±è´¥"
        # å°è¯•æ¢å¤åŸè§„åˆ™
        log_warning "å°è¯•æ¢å¤åŸè§„åˆ™..."
        iptables -t nat -A PREROUTING -p tcp --dport "$old_relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$old_target_port" 2>/dev/null
        return 1
    fi
    
    if ! iptables -A FORWARD -p tcp --dport "$final_target_port" -j ACCEPT; then
        log_warning "æ·»åŠ æ–°FORWARDè§„åˆ™å¤±è´¥"
    fi
    
    # éªŒè¯æ–°è§„åˆ™
    if check_forward_exists "$final_relay_port"; then
        log_success "è½¬å‘è§„åˆ™ä¿®æ”¹æˆåŠŸ!"
        echo ""
        log_info "æ–°çš„è½¬å‘é…ç½®:"
        echo "  ${TARGET_SERVER_NAME}: $TARGET_SERVER_IP:$final_target_port"
        echo "  ${RELAY_SERVER_NAME}è®¿é—®: $RELAY_SERVER_IP:$final_relay_port"
        
        # æä¾›é…ç½®ä¿®æ”¹å»ºè®®
        if [ "$old_relay_port" != "$final_relay_port" ]; then
            echo ""
            log_info "å®¢æˆ·ç«¯é…ç½®éœ€è¦æ›´æ–°:"
            echo "  åŸé…ç½®: @$RELAY_SERVER_IP:$old_relay_port"
            echo "  æ–°é…ç½®: @$RELAY_SERVER_IP:$final_relay_port"
        fi
        
        return 0
    else
        log_error "è§„åˆ™ä¿®æ”¹éªŒè¯å¤±è´¥"
        return 1
    fi
}

# äº¤äº’å¼ä¿®æ”¹è½¬å‘è§„åˆ™
interactive_modify() {
    local relay_port=$1
    
    if ! validate_port "$relay_port"; then
        log_error "æ— æ•ˆçš„ä¸­è½¬ç«¯å£: $relay_port"
        return 1
    fi
    
    # æ£€æŸ¥è§„åˆ™æ˜¯å¦å­˜åœ¨
    if ! check_forward_exists "$relay_port"; then
        log_error "ä¸­è½¬ç«¯å£ $relay_port æ²¡æœ‰è½¬å‘è§„åˆ™"
        return 1
    fi
    
    # è·å–å½“å‰è§„åˆ™ä¿¡æ¯
    local rule_info=$(iptables -t nat -L PREROUTING -n --line-numbers 2>/dev/null | grep "dpt:$relay_port.*to:$TARGET_SERVER_IP")
    local current_target_port=$(echo "$rule_info" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
    
    echo -e "${BLUE}=== ä¿®æ”¹è½¬å‘è§„åˆ™ ===${NC}"
    echo ""
    echo -e "${YELLOW}å½“å‰é…ç½®:${NC}"
    echo "  ä¸­è½¬ç«¯å£: $relay_port"
    echo "  ç›®æ ‡ç«¯å£: $current_target_port"
    echo "  æ˜ å°„å…³ç³»: $RELAY_SERVER_IP:$relay_port â†’ $TARGET_SERVER_IP:$current_target_port"
    echo ""
    
    # è¯¢é—®ä¿®æ”¹é€‰é¡¹
    echo -e "${YELLOW}ä¿®æ”¹é€‰é¡¹:${NC}"
    echo "  1. åªä¿®æ”¹ç›®æ ‡ç«¯å£"
    echo "  2. åªä¿®æ”¹ä¸­è½¬ç«¯å£"
    echo "  3. åŒæ—¶ä¿®æ”¹ç›®æ ‡ç«¯å£å’Œä¸­è½¬ç«¯å£"
    echo "  4. å–æ¶ˆä¿®æ”¹"
    echo ""
    
    read -p "è¯·é€‰æ‹©ä¿®æ”¹é€‰é¡¹ (1-4): " -r choice
    
    local new_target_port=""
    local new_relay_port=""
    
    case "$choice" in
        1)
            read -p "è¯·è¾“å…¥æ–°çš„ç›®æ ‡ç«¯å£ [$current_target_port]: " -r new_target_port
            if [ -z "$new_target_port" ]; then
                new_target_port=$current_target_port
            fi
            ;;
        2)
            read -p "è¯·è¾“å…¥æ–°çš„ä¸­è½¬ç«¯å£ [$relay_port]: " -r new_relay_port
            if [ -z "$new_relay_port" ]; then
                new_relay_port=$relay_port
            fi
            ;;
        3)
            read -p "è¯·è¾“å…¥æ–°çš„ç›®æ ‡ç«¯å£ [$current_target_port]: " -r new_target_port
            read -p "è¯·è¾“å…¥æ–°çš„ä¸­è½¬ç«¯å£ [$relay_port]: " -r new_relay_port
            
            if [ -z "$new_target_port" ]; then
                new_target_port=$current_target_port
            fi
            if [ -z "$new_relay_port" ]; then
                new_relay_port=$relay_port
            fi
            ;;
        4)
            log_info "ä¿®æ”¹å·²å–æ¶ˆ"
            return 0
            ;;
        *)
            log_error "æ— æ•ˆçš„é€‰æ‹©"
            return 1
            ;;
    esac
    
    # ç¡®è®¤ä¿®æ”¹
    echo ""
    echo -e "${YELLOW}ä¿®æ”¹ç¡®è®¤:${NC}"
    echo "  åŸé…ç½®: $RELAY_SERVER_IP:$relay_port â†’ $TARGET_SERVER_IP:$current_target_port"
    echo "  æ–°é…ç½®: $RELAY_SERVER_IP:${new_relay_port:-$relay_port} â†’ $TARGET_SERVER_IP:${new_target_port:-$current_target_port}"
    echo ""
    
    read -p "ç¡®è®¤ä¿®æ”¹? (y/N): " -r confirm
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        log_info "ä¿®æ”¹å·²å–æ¶ˆ"
        return 0
    fi
    
    # æ‰§è¡Œä¿®æ”¹
    modify_port_forward "$relay_port" "$new_target_port" "$new_relay_port"
}

# åˆ é™¤ç«¯å£è½¬å‘è§„åˆ™
remove_port_forward() {
    local relay_port=$1
    local confirm=${2:-true}
    
    if ! validate_port "$relay_port"; then
        log_error "æ— æ•ˆçš„ç«¯å£å·: $relay_port"
        return 1
    fi
    
    # æŸ¥æ‰¾å¯¹åº”çš„è½¬å‘è§„åˆ™
    local rule_info=$(iptables -t nat -L PREROUTING -n --line-numbers 2>/dev/null | grep "dpt:$relay_port.*to:$TARGET_SERVER_IP")
    
    if [ -z "$rule_info" ]; then
        log_warning "ç«¯å£ $relay_port æ²¡æœ‰è½¬å‘è§„åˆ™"
        return 1
    fi
    
    # è§£æç›®æ ‡ç«¯å£
    local target_port=$(echo "$rule_info" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
    
    # æ˜¾ç¤ºè¦åˆ é™¤çš„è§„åˆ™ä¿¡æ¯
    log_info "å‡†å¤‡åˆ é™¤è½¬å‘è§„åˆ™: $RELAY_SERVER_IP:$relay_port â†’ $TARGET_SERVER_IP:$target_port"
    
    # ç¡®è®¤åˆ é™¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ "$confirm" = "true" ]; then
        read -p "ç¡®è®¤åˆ é™¤æ­¤è½¬å‘è§„åˆ™? (y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "åˆ é™¤å·²å–æ¶ˆ"
            return 0
        fi
    fi
    
    # åˆ é™¤PREROUTINGè§„åˆ™
    if iptables -t nat -D PREROUTING -p tcp --dport "$relay_port" -j DNAT --to-destination "$TARGET_SERVER_IP:$target_port" 2>/dev/null; then
        log_debug "PREROUTINGè§„åˆ™åˆ é™¤æˆåŠŸ"
    else
        log_warning "PREROUTINGè§„åˆ™åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
    fi
    
    # åˆ é™¤FORWARDè§„åˆ™
    if iptables -D FORWARD -p tcp --dport "$target_port" -j ACCEPT 2>/dev/null; then
        log_debug "FORWARDè§„åˆ™åˆ é™¤æˆåŠŸ"
    else
        log_warning "FORWARDè§„åˆ™åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
    fi
    
    # éªŒè¯åˆ é™¤ç»“æœ
    if ! check_forward_exists "$relay_port"; then
        log_success "ç«¯å£è½¬å‘åˆ é™¤æˆåŠŸ"
        return 0
    else
        log_error "ç«¯å£è½¬å‘åˆ é™¤å¤±è´¥"
        return 1
    fi
}

# åˆ—å‡ºæ‰€æœ‰è½¬å‘è§„åˆ™
list_port_forwards() {
    local search_port=$1
    
    if [ -n "$search_port" ]; then
        # æ˜¾ç¤ºç‰¹å®šç«¯å£çš„è¯¦ç»†ä¿¡æ¯
        echo -e "${BLUE}=== ç«¯å£ $search_port è¯¦ç»†ä¿¡æ¯ ===${NC}"
        
        local rule_info=$(iptables -t nat -L PREROUTING -n --line-numbers 2>/dev/null | grep "dpt:$search_port.*to:$TARGET_SERVER_IP")
        
        if [ -n "$rule_info" ]; then
            log_success "è½¬å‘è§„åˆ™å­˜åœ¨"
            echo "$rule_info"
            
            local target_port=$(echo "$rule_info" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
            echo ""
            echo -e "${CYAN}æ˜ å°„å…³ç³»:${NC}"
            echo "  ${RELAY_SERVER_NAME}: $RELAY_SERVER_IP:$search_port"
            echo "  ${TARGET_SERVER_NAME}: $TARGET_SERVER_IP:$target_port"
        else
            log_warning "æœªæ‰¾åˆ°è½¬å‘è§„åˆ™"
        fi
        
        echo ""
        echo -e "${CYAN}ç«¯å£å ç”¨æƒ…å†µ:${NC}"
        get_port_usage_detail "$search_port"
        
    else
        # æ˜¾ç¤ºæ‰€æœ‰è½¬å‘è§„åˆ™
        echo -e "${BLUE}=== æ‰€æœ‰ç«¯å£è½¬å‘è§„åˆ™ ===${NC}"
        
        local total_rules=$(iptables -t nat -L PREROUTING -n 2>/dev/null | grep -c "to:$TARGET_SERVER_IP")
        echo "è½¬å‘è§„åˆ™æ€»æ•°: $total_rules"
        
        if [ "$total_rules" -eq 0 ]; then
            log_warning "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è½¬å‘è§„åˆ™"
            return 0
        fi
        
        echo ""
        echo -e "${YELLOW}ä½¿ç”¨ç¤ºä¾‹:${NC}"
    echo "  $0 add 3389                     è½¬å‘3389ç«¯å£ï¼ˆç›¸åŒç«¯å£ï¼‰"
    echo "  $0 add 3389 13389               ç›®æ ‡3389ç«¯å£æ˜ å°„åˆ°ä¸­è½¬13389ç«¯å£"
    echo "  $0 auto 3389                    è‡ªåŠ¨ä¸º3389ç«¯å£åˆ†é…ä¸­è½¬ç«¯å£"
    echo "  $0 map 22 2222                  SSHç«¯å£æ˜ å°„"
    echo "  $0 modify 13389 3390            ä¿®æ”¹13389ç«¯å£çš„ç›®æ ‡ç«¯å£ä¸º3390"
    echo "  $0 modify 13389 3390 23389      ä¿®æ”¹ç›®æ ‡ç«¯å£ä¸º3390ï¼Œä¸­è½¬ç«¯å£ä¸º23389"
    echo "  $0 edit 13389                   äº¤äº’å¼ä¿®æ”¹13389ç«¯å£çš„è½¬å‘è§„åˆ™"
    echo "  $0 test 13389                   æµ‹è¯•13389ç«¯å£è½¬å‘"
    echo "  $0 find-free 40000              ä»40000å¼€å§‹æŸ¥æ‰¾å¯ç”¨ç«¯å£"
    echo ""
    echo -e "${YELLOW}é…ç½®æ–‡ä»¶:${NC}"
    echo "  ç¼–è¾‘è„šæœ¬é¡¶éƒ¨çš„é…ç½®åŒºåŸŸæ¥è®¾ç½®ç›®æ ‡æœåŠ¡å™¨å’Œä¸­è½¬æœåŠ¡å™¨ä¿¡æ¯"
}

# æ˜¾ç¤ºå½“å‰é…ç½®
show_config() {
    echo -e "${BLUE}=== å½“å‰é…ç½® ===${NC}"
    echo ""
    echo -e "${YELLOW}æœåŠ¡å™¨é…ç½®:${NC}"
    echo "  ç›®æ ‡æœåŠ¡å™¨IP: $TARGET_SERVER_IP"
    echo "  ç›®æ ‡æœåŠ¡å™¨åç§°: $TARGET_SERVER_NAME"
    echo "  ä¸­è½¬æœåŠ¡å™¨IP: $RELAY_SERVER_IP"
    echo "  ä¸­è½¬æœåŠ¡å™¨åç§°: $RELAY_SERVER_NAME"
    echo ""
    echo -e "${YELLOW}ç³»ç»Ÿé…ç½®:${NC}"
    echo "  è§„åˆ™ä¿å­˜è·¯å¾„: $RULES_FILE"
    echo "  è‡ªåŠ¨ç«¯å£èµ·å§‹: $AUTO_PORT_START"
    echo ""
    echo -e "${YELLOW}ä¿®æ”¹é…ç½®:${NC}"
    echo "  ç¼–è¾‘è„šæœ¬æ–‡ä»¶ï¼Œä¿®æ”¹é¡¶éƒ¨é…ç½®åŒºåŸŸçš„å˜é‡"
    echo "  æˆ–å¤åˆ¶è„šæœ¬åˆ°æ–°æ–‡ä»¶å¹¶ä¿®æ”¹é…ç½®"
}

# æ‰¹é‡æ·»åŠ ç«¯å£èŒƒå›´
add_port_range() {
    local start_port=$1
    local end_port=$2
    
    if ! validate_port "$start_port" || ! validate_port "$end_port"; then
        log_error "æ— æ•ˆçš„ç«¯å£èŒƒå›´: $start_port-$end_port"
        return 1
    fi
    
    if [ "$start_port" -gt "$end_port" ]; then
        log_error "èµ·å§‹ç«¯å£ä¸èƒ½å¤§äºç»“æŸç«¯å£"
        return 1
    fi
    
    local total_ports=$((end_port - start_port + 1))
    if [ "$total_ports" -gt 1000 ]; then
        log_warning "ç«¯å£èŒƒå›´è¿‡å¤§($total_portsä¸ªç«¯å£)ï¼Œå»ºè®®åˆ†æ‰¹å¤„ç†"
        read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(y/N): " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "æ“ä½œå·²å–æ¶ˆ"
            return 1
        fi
    fi
    
    log_info "æ‰¹é‡æ·»åŠ ç«¯å£èŒƒå›´: $start_port-$end_port ($total_portsä¸ªç«¯å£)"
    
    local success_count=0
    local fail_count=0
    
    for port in $(seq "$start_port" "$end_port"); do
        if add_port_forward "$port" "$port" false >/dev/null 2>&1; then
            ((success_count++))
        else
            ((fail_count++))
        fi
        
        # æ˜¾ç¤ºè¿›åº¦
        local current=$((port - start_port + 1))
        echo -ne "\r${CYAN}è¿›åº¦: $current/$total_ports (æˆåŠŸ: $success_count, å¤±è´¥: $fail_count)${NC}"
    done
    
    echo ""
    log_success "æ‰¹é‡æ·»åŠ å®Œæˆ: æˆåŠŸ $success_count ä¸ªï¼Œå¤±è´¥ $fail_count ä¸ª"
    
    if [ "$fail_count" -gt 0 ]; then
        log_info "å¤±è´¥çš„ç«¯å£å¯èƒ½å·²è¢«å ç”¨æˆ–å·²æœ‰è½¬å‘è§„åˆ™"
    fi
}

# æ¸…ç†å’Œç»´æŠ¤åŠŸèƒ½
cleanup_rules() {
    log_info "æ£€æŸ¥è½¬å‘è§„åˆ™å®Œæ•´æ€§..."
    
    local total_prerouting=0
    local total_forward=0
    local orphan_rules=0
    
    # ç»Ÿè®¡PREROUTINGè§„åˆ™
    total_prerouting=$(iptables -t nat -L PREROUTING -n 2>/dev/null | grep -c "to:$TARGET_SERVER_IP")
    
    # ç»Ÿè®¡FORWARDè§„åˆ™ï¼ˆè¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œç®€åŒ–å¤„ç†ï¼‰
    total_forward=$(iptables -L FORWARD -n 2>/dev/null | grep -c "ACCEPT")
    
    log_info "è§„åˆ™ç»Ÿè®¡:"
    echo "  PREROUTINGè§„åˆ™: $total_prerouting"
    echo "  FORWARDè§„åˆ™: $total_forward"
    
    # æ£€æŸ¥é‡å¤è§„åˆ™
    log_info "æ£€æŸ¥é‡å¤è§„åˆ™..."
    local duplicate_count=0
    
    # è·å–æ‰€æœ‰è½¬å‘ç«¯å£å¹¶æ£€æŸ¥é‡å¤
    local ports=($(iptables -t nat -L PREROUTING -n 2>/dev/null | grep "to:$TARGET_SERVER_IP" | grep -o "dpt:[0-9]*" | cut -d':' -f2 | sort))
    local prev_port=""
    
    for port in "${ports[@]}"; do
        if [ "$port" = "$prev_port" ]; then
            ((duplicate_count++))
            log_warning "å‘ç°é‡å¤ç«¯å£: $port"
        fi
        prev_port="$port"
    done
    
    if [ "$duplicate_count" -eq 0 ]; then
        log_success "æœªå‘ç°é‡å¤è§„åˆ™"
    else
        log_warning "å‘ç° $duplicate_count ä¸ªé‡å¤è§„åˆ™ï¼Œå»ºè®®æ‰‹åŠ¨æ¸…ç†"
    fi
    
    log_success "è§„åˆ™æ£€æŸ¥å®Œæˆ"
}

#================================================================
# ä¸»ç¨‹åºå…¥å£
#================================================================

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥è¿è¡Œæƒé™
    check_root
    
    # æ£€æŸ¥ç³»ç»Ÿä¾èµ–
    check_dependencies
    
    # æ£€æŸ¥é…ç½®
    check_config
    
    # éªŒè¯IPåœ°å€æ ¼å¼
    if ! validate_ip "$TARGET_SERVER_IP"; then
        log_error "æ— æ•ˆçš„ç›®æ ‡æœåŠ¡å™¨IPåœ°å€: $TARGET_SERVER_IP"
        exit 1
    fi
    
    if ! validate_ip "$RELAY_SERVER_IP"; then
        log_error "æ— æ•ˆçš„ä¸­è½¬æœåŠ¡å™¨IPåœ°å€: $RELAY_SERVER_IP"
        exit 1
    fi
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    case "${1:-help}" in
        "add")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šç›®æ ‡ç«¯å£å·"
                show_usage
                exit 1
            fi
            add_port_forward "$2" "$3"
            ;;
        "auto")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šç›®æ ‡ç«¯å£å·"
                show_usage
                exit 1
            fi
            add_port_forward "$2" "" true
            ;;
        "modify")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šè¦ä¿®æ”¹çš„ä¸­è½¬ç«¯å£å·"
                echo "ç”¨æ³•: $0 modify <ä¸­è½¬ç«¯å£> [æ–°ç›®æ ‡ç«¯å£] [æ–°ä¸­è½¬ç«¯å£]"
                exit 1
            fi
            # æ£€æŸ¥æ˜¯å¦æœ‰--forceå‚æ•°
            local force="false"
            if [[ "$*" == *"--force"* ]]; then
                force="true"
            fi
            modify_port_forward "$2" "$3" "$4" "$force"
            ;;
        "edit")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šè¦ä¿®æ”¹çš„ä¸­è½¬ç«¯å£å·"
                echo "ç”¨æ³•: $0 edit <ä¸­è½¬ç«¯å£>"
                exit 1
            fi
            interactive_modify "$2"
            ;;
        "map")
            if [ -z "$2" ] || [ -z "$3" ]; then
                log_error "è¯·æŒ‡å®šç›®æ ‡ç«¯å£å’Œä¸­è½¬ç«¯å£"
                echo "ç”¨æ³•: $0 map <ç›®æ ‡ç«¯å£> <ä¸­è½¬ç«¯å£>"
                exit 1
            fi
            add_port_forward "$2" "$3"
            ;;
        "remove")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šè¦åˆ é™¤çš„ä¸­è½¬ç«¯å£å·"
                exit 1
            fi
            # æ£€æŸ¥æ˜¯å¦æœ‰--forceå‚æ•°ï¼ˆè·³è¿‡ç¡®è®¤ï¼‰
            local force_remove="false"
            if [[ "$*" == *"--force"* ]]; then
                force_remove="true"
            fi
            remove_port_forward "$2" "$([ "$force_remove" = "true" ] && echo "false" || echo "true")"
            ;;
        "range")
            if [ -z "$2" ] || [ -z "$3" ]; then
                log_error "è¯·æŒ‡å®šç«¯å£èŒƒå›´"
                echo "ç”¨æ³•: $0 range <èµ·å§‹ç«¯å£> <ç»“æŸç«¯å£>"
                exit 1
            fi
            add_port_range "$2" "$3"
            ;;
        "list")
            list_port_forwards "$2"
            ;;
        "status")
            show_status
            ;;
        "test")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šè¦æµ‹è¯•çš„ä¸­è½¬ç«¯å£å·"
                exit 1
            fi
            test_port_forward "$2"
            ;;
        "check")
            if [ -z "$2" ]; then
                log_error "è¯·æŒ‡å®šè¦æ£€æŸ¥çš„ç«¯å£å·"
                exit 1
            fi
            echo -e "${BLUE}=== ç«¯å£ $2 å ç”¨æƒ…å†µ ===${NC}"
            get_port_usage_detail "$2"
            ;;
        "find-free")
            local found_port=$(find_available_port "$2")
            if [ $? -eq 0 ]; then
                log_success "æ‰¾åˆ°å¯ç”¨ç«¯å£: $found_port"
            fi
            ;;
        "save")
            save_rules
            ;;
        "restore")
            restore_rules
            ;;
        "backup")
            backup_rules
            ;;
        "info")
            show_connection_info
            ;;
        "config")
            show_config
            ;;
        "cleanup")
            cleanup_rules
            ;;
        "help"|"--help"|"-h"|"")
            show_usage
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $1"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# è„šæœ¬å…¥å£ç‚¹
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi}è½¬å‘æ˜ å°„åˆ—è¡¨:${NC}"
        printf "%-6s %-15s %-15s %-10s\n" "åºå·" "${RELAY_SERVER_NAME}ç«¯å£" "${TARGET_SERVER_NAME}ç«¯å£" "çŠ¶æ€"
        echo "------------------------------------------------"
        
        local count=1
        iptables -t nat -L PREROUTING -n 2>/dev/null | grep "to:$TARGET_SERVER_IP" | head -20 | while IFS= read -r line; do
            local relay_port=$(echo "$line" | grep -o "dpt:[0-9]*" | cut -d':' -f2)
            local target_port=$(echo "$line" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
            
            local status="æ­£å¸¸"
            if ! check_port_in_use "$relay_port"; then
                status="æœªå ç”¨"
            fi
            
            printf "%-6s %-15s %-15s %-10s\n" "$count" "$relay_port" "$target_port" "$status"
            ((count++))
        done
        
        if [ "$total_rules" -gt 20 ]; then
            echo "..."
            echo "ï¼ˆæ˜¾ç¤ºå‰20æ¡ï¼Œæ€»å…± $total_rules æ¡è§„åˆ™ï¼‰"
            log_info "ä½¿ç”¨ '$0 list <ç«¯å£>' æŸ¥çœ‹ç‰¹å®šç«¯å£è¯¦æƒ…"
        fi
    fi
}

# æµ‹è¯•ç«¯å£è½¬å‘
test_port_forward() {
    local relay_port=$1
    
    if ! validate_port "$relay_port"; then
        log_error "æ— æ•ˆçš„ç«¯å£å·: $relay_port"
        return 1
    fi
    
    log_info "æµ‹è¯•ç«¯å£ $relay_port è½¬å‘çŠ¶æ€..."
    
    # æ£€æŸ¥è½¬å‘è§„åˆ™æ˜¯å¦å­˜åœ¨
    if ! check_forward_exists "$relay_port"; then
        log_error "ç«¯å£ $relay_port æ²¡æœ‰é…ç½®è½¬å‘è§„åˆ™"
        return 1
    fi
    
    # è·å–ç›®æ ‡ç«¯å£
    local rule_info=$(iptables -t nat -L PREROUTING -n 2>/dev/null | grep "dpt:$relay_port.*to:$TARGET_SERVER_IP")
    local target_port=$(echo "$rule_info" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
    
    echo ""
    log_info "è½¬å‘é…ç½®: $RELAY_SERVER_IP:$relay_port â†’ $TARGET_SERVER_IP:$target_port"
    
    # æµ‹è¯•æœ¬åœ°ç«¯å£è¿é€šæ€§
    log_info "æµ‹è¯•ä¸­è½¬æœåŠ¡å™¨ç«¯å£è¿é€šæ€§..."
    if timeout 3 bash -c "echo > /dev/tcp/127.0.0.1/$relay_port" 2>/dev/null; then
        log_success "ä¸­è½¬ç«¯å£ $relay_port å¯ä»¥è¿æ¥"
    else
        log_warning "ä¸­è½¬ç«¯å£ $relay_port è¿æ¥å¤±è´¥ï¼ˆç›®æ ‡æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼‰"
    fi
    
    # æµ‹è¯•åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿é€šæ€§
    log_info "æµ‹è¯•åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿é€šæ€§..."
    if timeout 3 bash -c "echo > /dev/tcp/$TARGET_SERVER_IP/$target_port" 2>/dev/null; then
        log_success "ç›®æ ‡æœåŠ¡å™¨ $TARGET_SERVER_IP:$target_port å¯ä»¥è¿æ¥"
    else
        log_warning "ç›®æ ‡æœåŠ¡å™¨ $TARGET_SERVER_IP:$target_port è¿æ¥å¤±è´¥"
    fi
    
    echo ""
    log_info "æµ‹è¯•å®Œæˆã€‚å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥:"
    echo "  1. ç›®æ ‡æœåŠ¡å™¨ $TARGET_SERVER_IP æ˜¯å¦å¯è¾¾"
    echo "  2. ç›®æ ‡ç«¯å£ $target_port ä¸Šæ˜¯å¦æœ‰æœåŠ¡è¿è¡Œ"
    echo "  3. é˜²ç«å¢™è®¾ç½®æ˜¯å¦æ­£ç¡®"
}

#================================================================
# è§„åˆ™ç®¡ç†å‡½æ•°
#================================================================

# ä¿å­˜iptablesè§„åˆ™
save_rules() {
    log_info "ä¿å­˜iptablesè§„åˆ™..."
    
    # åˆ›å»ºç›®å½•
    mkdir -p "$(dirname "$RULES_FILE")"
    
    # ä¿å­˜è§„åˆ™
    if iptables-save > "$RULES_FILE" 2>/dev/null; then
        log_success "è§„åˆ™å·²ä¿å­˜åˆ° $RULES_FILE"
        log_info "é‡å¯åå°†è‡ªåŠ¨åŠ è½½è¿™äº›è§„åˆ™"
        
        # å®‰è£…iptables-persistentï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if command -v apt-get >/dev/null 2>&1; then
            if ! dpkg -l | grep -q iptables-persistent; then
                log_info "å»ºè®®å®‰è£… iptables-persistent ä»¥ç¡®ä¿è§„åˆ™æ°¸ä¹…ç”Ÿæ•ˆ:"
                log_info "  sudo apt install iptables-persistent"
            fi
        fi
    else
        log_error "ä¿å­˜è§„åˆ™å¤±è´¥"
        return 1
    fi
}

# æ¢å¤iptablesè§„åˆ™
restore_rules() {
    if [ ! -f "$RULES_FILE" ]; then
        log_error "è§„åˆ™æ–‡ä»¶ $RULES_FILE ä¸å­˜åœ¨"
        return 1
    fi
    
    log_info "æ¢å¤iptablesè§„åˆ™..."
    
    if iptables-restore < "$RULES_FILE" 2>/dev/null; then
        log_success "è§„åˆ™å·²ä» $RULES_FILE æ¢å¤"
    else
        log_error "æ¢å¤è§„åˆ™å¤±è´¥"
        return 1
    fi
}

# å¤‡ä»½å½“å‰è§„åˆ™
backup_rules() {
    local backup_file="/root/iptables_backup_$(date +%Y%m%d_%H%M%S).txt"
    
    log_info "å¤‡ä»½å½“å‰iptablesè§„åˆ™..."
    
    if iptables-save > "$backup_file" 2>/dev/null; then
        log_success "è§„åˆ™å·²å¤‡ä»½åˆ° $backup_file"
    else
        log_error "å¤‡ä»½è§„åˆ™å¤±è´¥"
        return 1
    fi
}

# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
show_status() {
    echo -e "${BLUE}=== ç«¯å£è½¬å‘ç³»ç»ŸçŠ¶æ€ ===${NC}"
    echo ""
    
    # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
    echo -e "${YELLOW}é…ç½®ä¿¡æ¯:${NC}"
    echo "  ç›®æ ‡æœåŠ¡å™¨: $TARGET_SERVER_NAME ($TARGET_SERVER_IP)"
    echo "  ä¸­è½¬æœåŠ¡å™¨: $RELAY_SERVER_NAME ($RELAY_SERVER_IP)"
    echo ""
    
    # æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
    echo -e "${YELLOW}ç³»ç»ŸçŠ¶æ€:${NC}"
    echo "  IPè½¬å‘çŠ¶æ€: $([ "$(cat /proc/sys/net/ipv4/ip_forward)" = "1" ] && echo -e "${GREEN}å·²å¯ç”¨${NC}" || echo -e "${RED}æœªå¯ç”¨${NC}")"
    
    local total_rules=$(iptables -t nat -L PREROUTING -n 2>/dev/null | grep -c "to:$TARGET_SERVER_IP")
    echo "  è½¬å‘è§„åˆ™æ•°é‡: $total_rules"
    
    # æ£€æŸ¥é‡è¦ç«¯å£çŠ¶æ€
    echo ""
    echo -e "${YELLOW}é‡è¦ç«¯å£çŠ¶æ€:${NC}"
    local important_ports=(22 80 443 3389 8080 8443)
    
    for port in "${important_ports[@]}"; do
        local status=$(check_port_available "$port")
        if [ "$status" = "available" ]; then
            echo -e "  ç«¯å£ $port: ${GREEN}å¯ç”¨${NC}"
        else
            echo -e "  ç«¯å£ $port: ${RED}å ç”¨${NC} ($status)"
        fi
    done
    
    # æ˜¾ç¤ºæœ€è¿‘çš„è½¬å‘è§„åˆ™
    if [ "$total_rules" -gt 0 ]; then
        echo ""
        echo -e "${YELLOW}æœ€è¿‘çš„è½¬å‘è§„åˆ™:${NC}"
        iptables -t nat -L PREROUTING -n 2>/dev/null | grep "to:$TARGET_SERVER_IP" | head -5 | while IFS= read -r line; do
            local relay_port=$(echo "$line" | grep -o "dpt:[0-9]*" | cut -d':' -f2)
            local target_port=$(echo "$line" | grep -o "to:$TARGET_SERVER_IP:[0-9]*" | cut -d':' -f3)
            echo "  $relay_port â†’ $target_port"
        done
    fi
}

# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
show_connection_info() {
    echo -e "${BLUE}=== è¿æ¥ä¿¡æ¯ ===${NC}"
    echo ""
    
    echo -e "${YELLOW}æœåŠ¡å™¨ä¿¡æ¯:${NC}"
    echo "  ${TARGET_SERVER_NAME}: $TARGET_SERVER_IP"
    echo "  ${RELAY_SERVER_NAME}: $RELAY_SERVER_IP"
    echo ""
    
    echo -e "${YELLOW}ä½¿ç”¨è¯´æ˜:${NC}"
    echo "  1. åŸå§‹è¿æ¥: å®¢æˆ·ç«¯ â†’ $TARGET_SERVER_IP:ç«¯å£"
    echo "  2. ä¸­è½¬è¿æ¥: å®¢æˆ·ç«¯ â†’ $RELAY_SERVER_IP:ç«¯å£ â†’ $TARGET_SERVER_IP:ç«¯å£"
    echo ""
    
    echo -e "${YELLOW}é…ç½®ä¿®æ”¹:${NC}"
    echo "  å°†åŸé…ç½®ä¸­çš„ $TARGET_SERVER_IP æ›¿æ¢ä¸º $RELAY_SERVER_IP"
    echo "  å¦‚æœç«¯å£æœ‰å˜åŒ–ï¼ŒåŒæ—¶æ›´æ–°ç«¯å£å·"
    echo ""
    
    echo -e "${YELLOW}å¸¸ç”¨å‘½ä»¤:${NC}"
    echo "  æ·»åŠ è½¬å‘: $0 add <ç›®æ ‡ç«¯å£> [ä¸­è½¬ç«¯å£]"
    echo "  è‡ªåŠ¨åˆ†é…: $0 auto <ç›®æ ‡ç«¯å£>"
    echo "  æŸ¥çœ‹çŠ¶æ€: $0 status"
    echo "  æµ‹è¯•è¿æ¥: $0 test <ä¸­è½¬ç«¯å£>"
}

#================================================================
# ä¸»ç¨‹åºå’Œå‘½ä»¤è¡Œæ¥å£
#================================================================

# æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©
show_usage() {
    echo -e "${BLUE}=== é€šç”¨ç«¯å£è½¬å‘ç®¡ç†å·¥å…· ===${NC}"
    echo ""
    echo -e "${PURPLE}å½“å‰é…ç½®:${NC}"
    echo "  ç›®æ ‡æœåŠ¡å™¨: $TARGET_SERVER_NAME ($TARGET_SERVER_IP)"
    echo "  ä¸­è½¬æœåŠ¡å™¨: $RELAY_SERVER_NAME ($RELAY_SERVER_IP)"
    echo ""
    echo "ç”¨æ³•: $0 {å‘½ä»¤} [å‚æ•°]"
    echo ""
    echo -e "${YELLOW}ç«¯å£è½¬å‘å‘½ä»¤:${NC}"
    echo "  add <ç›®æ ‡ç«¯å£> [ä¸­è½¬ç«¯å£]        æ·»åŠ ç«¯å£è½¬å‘ï¼ˆå¯æŒ‡å®šä¸åŒç«¯å£ï¼‰"
    echo "  auto <ç›®æ ‡ç«¯å£>                 è‡ªåŠ¨åˆ†é…ä¸­è½¬ç«¯å£"
    echo "  map <ç›®æ ‡ç«¯å£> <ä¸­è½¬ç«¯å£>       æ˜ å°„åˆ°æŒ‡å®šä¸­è½¬ç«¯å£"
    echo "  modify <ä¸­è½¬ç«¯å£> [æ–°ç›®æ ‡ç«¯å£] [æ–°ä¸­è½¬ç«¯å£]  ä¿®æ”¹ç°æœ‰è½¬å‘è§„åˆ™"
    echo "  edit <ä¸­è½¬ç«¯å£>                 äº¤äº’å¼ä¿®æ”¹è½¬å‘è§„åˆ™"
    echo "  remove <ä¸­è½¬ç«¯å£>               åˆ é™¤ç«¯å£è½¬å‘"
    echo "  range <èµ·å§‹ç«¯å£> <ç»“æŸç«¯å£>     æ‰¹é‡æ·»åŠ ç›¸åŒç«¯å£è½¬å‘"
    echo ""
    echo -e "${YELLOW}æŸ¥çœ‹å’Œæµ‹è¯•å‘½ä»¤:${NC}"
    echo "  list [ç«¯å£]                     æ˜¾ç¤ºè½¬å‘è§„åˆ™åˆ—è¡¨"
    echo "  status                          æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€"
    echo "  test <ä¸­è½¬ç«¯å£>                 æµ‹è¯•ç«¯å£è½¬å‘"
    echo "  check <ç«¯å£>                    æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ"
    echo "  find-free [èµ·å§‹ç«¯å£]            æŸ¥æ‰¾å¯ç”¨ç«¯å£"
    echo ""
    echo -e "${YELLOW}ç®¡ç†å‘½ä»¤:${NC}"
    echo "  save                            ä¿å­˜å½“å‰è§„åˆ™"
    echo "  restore                         æ¢å¤ä¿å­˜çš„è§„åˆ™"
    echo "  backup                          å¤‡ä»½å½“å‰è§„åˆ™"
    echo "  info                            æ˜¾ç¤ºè¿æ¥ä¿¡æ¯"
    echo "  config                          æ˜¾ç¤ºå½“å‰é…ç½®"
    echo ""
    echo -e "${YELLOW
```



------

**ç‰ˆæœ¬**: 2.0
 **æœ€åæ›´æ–°**: 2025å¹´06æœˆ
 **ä½œè€…**: supresong
 **è®¸å¯è¯**: MIT License
